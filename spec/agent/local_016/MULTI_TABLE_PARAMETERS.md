# 複数テーブル構成とパラメータ最適化 仕様書

## 1. 概要

### 1.1 目的

レインボーテーブルを**複数枚構成**（multi-table）にすることで、単一テーブルの理論上限（約76%）を超えるカバー率を実現する。

### 1.2 背景・問題

#### 現状の課題

| 課題 | 詳細 |
|------|------|
| 単一テーブルの理論上限 | マージ効果により約76%が上限 |
| 単純指数モデルの誤り | `1-e^(-mt/N)` は実測と大きく乖離 |
| ファイルサイズ制約 | .g7rt と .g7ms の総サイズ最小化が必要 |

#### 用語定義

| 用語 | 定義 |
|------|------|
| **チェーン長 (t)** | 各チェーンのステップ数。`MAX_CHAIN_LENGTH` |
| **チェーン数 (m)** | テーブルあたりのチェーン数。`NUM_CHAINS` |
| **テーブル枚数 (T)** | 使用するテーブルの数。`NUM_TABLES` |
| **テーブル番号 (table_id)** | 0 から T-1 までの識別子 |
| **salt** | reduction関数に組み込むテーブル固有の値（= table_id） |
| **Seed空間 (N)** | 2^32 = 4,294,967,296 |
| **有効係数 (η)** | マージによるカバー率低下を表す係数 |

### 1.3 期待効果

| 効果 | 値 |
|------|-----|
| カバー率 | 99.90% |
| .g7rt サイズ | 79.00 MB |
| .g7ms サイズ | 16.58 MB |
| 総サイズ | 95.58 MB |
| 欠落シード数 | 約435万 |

---

## 2. 対象ファイル

| ファイル | 変更種別 | 変更内容 |
|----------|----------|----------|
| `constants.rs` | 修正 | パラメータ値の更新 |

---

## 3. 設計方針

### 3.1 カバー率モデル

実測データから導出した**逆比例モデル**を採用：

$$C_{single} = 1 - e^{-x \cdot \eta}, \quad x = \frac{mt}{N}, \quad \eta = \frac{1}{1 + 0.7x}$$

$$C_{total} = 1 - (1 - C_{single})^T$$

#### モデル検証（実測との比較）

| t | m | 予測カバー率 | 実測カバー率 | 誤差 |
|---|---|-------------|-------------|------|
| 2^13 | 45×2^13 | 99.9468% | 99.9470% | +0.0002% |
| 2^12 | 79×2^13 | 99.8988% | 99.8987% | -0.0001% |
| 2^11 | 128×2^13 | 99.7331% | 99.7319% | -0.0012% |

### 3.2 ファイルサイズモデル

$$S_{g7rt} = m \times 8 \times T$$

$$S_{g7ms} = N \times (1 - C_{total}) \times 4$$

$$S_{total} = S_{g7rt} + S_{g7ms}$$

### 3.3 最適化問題

$x = mt/N$ を変数として総サイズを最小化：

$$\frac{S_{total}}{N} = \frac{8Tx}{t} + 4 \cdot (1 - C_{total})$$

t=4096, T=16 を代入し、微分して0とおく：

$$\frac{d}{dx}\left(\frac{S_{total}}{N}\right) = \frac{1}{32} - \frac{64 \cdot \exp\left(\frac{-16x}{1+0.7x}\right)}{(1+0.7x)^2} = 0$$

数値解: $x_{opt} = 0.6184$

$$m_{opt} = \frac{x_{opt} \cdot N}{t} = 648,439 \approx 79 \times 2^{13}$$

### 3.4 採用パラメータ

| パラメータ | 値 | 備考 |
|------------|-----|------|
| t (MAX_CHAIN_LENGTH) | 4,096 (2^12) | チェーン長 |
| m (NUM_CHAINS) | 647,168 (79×2^13) | テーブルあたり |
| T (NUM_TABLES) | 16 (2^4) | テーブル枚数 |

#### パラメータ選定理由

1. **総ファイルサイズ最小化**: .g7rt + .g7ms の総和を最小化する最適点
2. **t=4096**: 検索時の計算コストと総サイズのバランス
3. **m=79×2^13**: 数学的導出による最適値

### 3.5 不採用案（ADR）

#### 不採用: t=2^13, m=45×2^13（総サイズ53.68MB）

- **検討内容**: より小さな総サイズで高カバー率（99.95%）
- **不採用理由**: 検索時の計算コストが2倍（チェーン長が2倍）

#### 不採用: t=2^11, m=128×2^13（総サイズ171.93MB）

- **検討内容**: 高速検索が可能
- **不採用理由**: 総サイズが大きすぎる

---

## 4. 実装仕様

### 4.1 constants.rs

```rust
/// Maximum chain length (t = 2^12 = 4,096)
#[cfg(not(test))]
pub const MAX_CHAIN_LENGTH: u32 = 1 << 12; // 4,096

/// Number of chains per table (m = 79 * 2^13 = 647,168)
///
/// Optimized for minimum total file size (.g7rt + .g7ms)
/// .g7rt: 79 MB, .g7ms: ~17 MB, Total: ~96 MB
#[cfg(not(test))]
pub const NUM_CHAINS: u32 = 79 * (1 << 13); // 647,168

/// Number of tables (T = 16)
pub const NUM_TABLES: u32 = 1 << 4; // 16
```

---

## 5. テスト方針

### 5.1 実測検証

| テスト | 検証内容 |
|--------|----------|
| `examples/measure_coverage.rs` | 任意のパラメータでカバー率を実測 |

---

## 6. 実装チェックリスト

- [x] カバー率モデルの検証（実測との比較）
- [x] 総ファイルサイズ最小化の数学的導出
- [x] `constants.rs` のパラメータ更新
- [x] 実測検証ツール（measure_coverage.rs）の整備

---

## 付録: 実測データ

### A.1 t=2^12, m=79×2^13 での実測

| 項目 | 予測 | 実測 |
|------|------|------|
| カバー率 | 99.8988% | 99.8987% |
| 欠落シード | 4,346,626 | 4,352,346 |
| .g7rt | 79.00 MB | 79.00 MB |
| .g7ms | 16.58 MB | 16.60 MB |
| 総サイズ | 95.58 MB | 95.60 MB |
| 処理時間 | - | 1,802秒 |

### A.2 各tでの最適点比較

| t | m | 予測カバー率 | 予測総サイズ | 実測総サイズ |
|---|---|-------------|-------------|-------------|
| 2^13 | 45×2^13 | 99.95% | 53.71 MB | 53.68 MB |
| 2^12 | 79×2^13 | 99.90% | 95.58 MB | 95.60 MB |
| 2^11 | 128×2^13 | 99.73% | 171.73 MB | 171.93 MB |
